
apiVersion: v1
kind: Pod
metadata:
  name: {{ .Release.Name }}-test-couchbase
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": test-success
    # "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: test-couchbase
      image: couchbase/server:6.6.0
      env:
      # For simplification we assume that the connection string here is the same as the one used by Sync Gateway...
        - name: COUCHBASE_USER
          value: {{ include "couchbase_username" . | quote }}
        - name: COUCHBASE_BUCKET
          value: {{ include "couchbase_bucket" . | quote }}
        - name: COUCHBASE_HOST
          value: {{ include "couchbase_connStr" . | quote }}
        - name: COUCHBASE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "couchbase_username" . }}-password
              key: password
      command:
        - /bin/bash
        - -ec
        - |
          echo Testing Couchbase connection
          timeout 10 cbq -e $COUCHBASE_HOST -u $COUCHBASE_USER -p $COUCHBASE_PASSWORD --script="SELECT COUNT(*) from \`$COUCHBASE_BUCKET\`;" --exit-on-error

